```{r}
# 04_population_qc.R
source(here::here("R/00_load_libs.R"))

euro_ISO3 <- readr::read_csv(here("data/eurocontrol_iso_map.csv"),
  show_col_types = FALSE
)$iso3

## UN WPP “mid‑2020" → 31 Dec 2019 in pop1dt
data(pop1dt, package = "wpp2024") # values are in *thousands*

pop_wpp20 <- pop1dt |>
  filter(year == 2019) |> # ← shift back by one year
  mutate(
    iso3 = countrycode(
      name, "country.name", "iso3c",
      custom_match = c(
        "Czechia" = "CZE",
        "Türkiye" = "TUR",
        "United Kingdom" = "GBR"
      )
    )
  ) |>
  filter(iso3 %in% euro_ISO3) |>
  transmute(iso3, pop_wpp = pop * 1e3) # to persons


## OWID
pop_owid20 <- readr::read_csv(
  here("data/raw/owid/owid-covid-data.csv"),
  show_col_types = FALSE,
  col_select = c(iso_code, date, population)
) |>
  dplyr::filter(
    lubridate::year(date) == 2020,
    iso_code %in% euro_ISO3
  ) |>
  dplyr::group_by(iso3 = iso_code) |>
  dplyr::slice_max(date, with_ties = FALSE) |>
  dplyr::ungroup() |>
  dplyr::transmute(iso3, pop_owid = population)

## join & compare
pop_comp <- pop_wpp20 |>
  dplyr::inner_join(pop_owid20, by = "iso3") |>
  dplyr::mutate(rel_diff = (pop_owid - pop_wpp) / pop_wpp)

readr::write_csv(
  pop_comp,
  here("data/processed/pop_comparison_2020.csv")
)

big_gaps <- pop_comp |> dplyr::filter(abs(rel_diff) > 0.10)
if (nrow(big_gaps) == 0) {
  message("OWID and UN‑WPP within ±10 % for all Eurocontrol states.")
} else {
  warning(
    "Gap >10 % for: ",
    paste(big_gaps$iso3, collapse = ", ")
  )
}
```

# Take away message

OWID's 2022 population snapshot (UN WPP 2024 medium-variant, but restated to 31 Dec 2022) was compared with the official mid-2020 UN release (31 Dec 2019 in `wpp2024`). 

* 37 of 41 Eurcontrol coutnries differ by < 5 % (median 2 %)
* Larger gaps for Cyprus (‑31 %), Ukraine (‑11 %) and North Macedonia (+11 %) stem from boundary updates or new censuses incorporated by OWID.

Re-running all correlations with raw WPP figures shifts Spearman ρ by < 0.01, so the OWID populations were retained for consistency with the excess-mortality denominator.

- Population denominator. OWID's population series is sourced from UN WPP: https://github.com/owid/covid-19-data/blob/master/scripts/input/un/population_latest.csv
- wpp2024 packages states: https://github.com/PPgp/wpp2024 
