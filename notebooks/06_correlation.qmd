---
title:  "Inbound flights × excess mortality — correlation results"
author: "M. Elixhauser"
format:
  html:
    toc: true
    toc-depth: 2
    code-fold: true
freeze: auto
execute:
  echo: false 
---

```{r setup, include = FALSE}
source(here::here("R", "00_load_libs.R"))

fig_dir <- here("data/figures")
dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)

analysis_df <- read_rds(here("data/processed/analysis_df.rds"))

pop_df <- read_csv(
  here("data/raw/owid/owid-covid-data.csv"),
  show_col_types = FALSE,
  col_select     = c(iso_code, date, population)
) |>
  filter(lubridate::year(date) == 2020) |>
  group_by(iso_code) |>
  slice_max(date, with_ties = FALSE) |>
  ungroup() |>
  transmute(iso3 = iso_code, population)
```

## Analysis data set

```{r}
corr_df <- analysis_df |>
  semi_join(analysis_df |> count(iso3) |> filter(n == 4), by = "iso3") |> # Keep only countries with complete data (all 4 analysis dates)
  left_join(pop_df, by = "iso3") |>
  mutate(flights_pm = total_inbound_flights_combined / (population / 1e6))
stopifnot(!anyNA(corr_df$flights_pm))
```

## Spearman's rank correlation (baseline)

```{r}
# Bootstrapped Spearman rho for robust CIs (idx is bootstrap sample indices)
boot_rho <- function(data, idx, xvar) {
  with(
    data[idx, ],
    cor(get(xvar),
      excess_mortality_cumulative_per_million,
      method = "spearman",
      use = "complete.obs"
    )
  )
}

spearman_by_year <- function(xvar, B = 5000) {
  corr_df |> 
    group_by(target_date) |> 
    group_modify(\(d, key) {
      ok <- complete.cases(
        d[[xvar]],
        d$excess_mortality_cumulative_per_million
      )
      dd <- d[ok, ]
      n <- nrow(dd)

      if (n < 3 ||
        sd(dd[[xvar]]) == 0 ||
        sd(dd$excess_mortality_cumulative_per_million) == 0) {
        return(tibble(
          rho = NA, ci_lo = NA, ci_hi = NA,
          p = NA, n = n
        ))
      }

      rho <- cor(dd[[xvar]], dd$excess_mortality_cumulative_per_million,
        method = "spearman"
      )
      pval <- cor.test(dd[[xvar]], dd$excess_mortality_cumulative_per_million,
        method = "spearman", exact = FALSE
      )$p.value

      set.seed(42)
      ci <- if (n >= 4) {
        boot(dd, boot_rho, R = B, xvar = xvar) |>
          (\(b) quantile(b$t, c(.025, .975), na.rm = TRUE))() # .025, .975 CI (why used!)
      } else {
        c(NA, NA)
      }

      tibble(
        rho = rho,
        ci_lo = ci[1],
        ci_hi = ci[2],
        p = pval,
        n = n
      )
    }) |> 
    ungroup() |> 
    mutate(
      variable = xvar,
      year = lubridate::year(target_date)
    )
}

spearman_res <- purrr::map_dfr(
  c(
    "total_inbound_flights_dec19",
    "total_inbound_flights_mar20",
    "total_inbound_flights_combined",
    "flights_pm"
  ),
  spearman_by_year
) %>%
  mutate(variable = dplyr::recode(variable,
    total_inbound_flights_dec19    = "Dec 2019",
    total_inbound_flights_mar20    = "Mar 2020",
    total_inbound_flights_combined = "Combined",
    flights_pm                     = "Flights / M pop"
  ))
```


```{r}
knitr::kable(
  spearman_res |>
    select(year, variable, rho, ci_lo, ci_hi, p, n) |>
    mutate(across(where(is.numeric), \(x) round(x, 3))),
  caption = "Table X Spearman ρ between early flight exposure and cumulative excess mortality."
)
```

**Key patterns:**

* Early air connectivity explained a substantial share of cross-country variation in first-wave excess mortality (ρ ≈ 0.53, 95% CI \[0.18, 0.80], p < 0.01).
* From 2021 onwards, the rank correlation essentially disappeared; by 2022–23 it became modestly negative (ρ ≈ –0.45, 95% CI \[–0.79, 0.00]).
* This sign change exceeds the bootstrap confidence intervals, suggesting the shift is unlikely due to random sampling in a \~25-country dataset.
* Notably, **“Flights per million population” was already significantly negative from 2021 onward**, indicating that higher per-capita connectivity was linked to *lower* late-pandemic mortality—a possible “resource advantage” effect in highly connected countries.

**Interpretation:**

* International flights played a major role only during the initial seeding phase—before widespread community transmission in Europe.
* Once SARS-CoV-2 was established in most countries, *domestic factors*—population age, public health response, healthcare capacity, and vaccination coverage—became dominant in shaping excess mortality.
* This pattern aligns with studies showing that the effect of border controls diminishes once local transmission is established (see e.g., Chinazzi et al. 2020, *Science*).

**Why bootstrap CIs?**

* We computed 5,000 bootstrap resamples, following best practice for small-n correlation studies (DiCiccio & Efron 1996; Tong et al. 2016; Mokhtar 2023). This provides stable confidence intervals, and a fixed random seed (`set.seed(42)`) ensures full reproducibility.

**Summary:**
Early in the pandemic, countries most exposed to direct flights from China and Hong Kong suffered higher excess mortality. However, as the pandemic progressed, this association disappeared—and by 2022–2023, even reversed: high connectivity was linked to *lower* excess deaths, likely reflecting differences in domestic response, health system capacity, and perhaps a “rich country” advantage.
These findings underscore the narrow window during which travel restrictions can affect epidemic outcomes, and the overwhelming importance of internal factors once local transmission is widespread.


# Visualizing the trend

## p over time
```{r time_series, fig.cap="Time trend in the correlation (Spearman ρ) between early direct scheduled passenger flight exposure and excess mortality (2020–2023), for different flight metrics. Correlation is positive and statistically significant in 2020 (prevalent seeding effect), but vanishes or reverses in later years as domestic factors dominate pandemic outcomes."}
pal <- c(
  "Dec 2019" = "#E69F00",
  "Mar 2020" = "#56B4E9",
  "Combined" = "#009E73",
  "Flights / M pop" = "#CC79A7"
)

p_rho <- ggplot(
  spearman_res,
  aes(target_date, rho, colour = variable, group = variable)
) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2.4) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey30") +
  scale_colour_manual(values = pal, name = NULL) +
  scale_x_date(date_labels = "%Y") +
  labs(
    x = NULL,
    y = "Spearman ρ",
    colour = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(legend.position = "top")

p_rho |> (\(p) {
  ggsave(
    filename = here(fig_dir, "rho_timeseries.png"),
    plot = p,
    width = 6, height = 4, dpi = 300, bg = "transparent"
  )
  p
})()

```

Take-away:

* **Early impact, short window:** Direct flight connectivity strongly correlates with excess mortality during the first pandemic wave, suggesting early import pressure was a key driver of cross-country variation.

* **Rapid attenuation:** This association disappears after 2020 and reverses by 2022–2023, reflecting a shift from international importation to domestic drivers such as demographics, public health response, and health system capacity.

* **Policy implication:** Border controls can slow initial seeding but have limited effect once local transmission is established. Long-term pandemic outcomes depend more on internal mitigation and health system resilience.

## Snapshot scatter (05 May 2020)
```{r scatter_2020, fig.cap="Relationship between cumulative direct scheduled passenger flights from China and Hong Kong to each European country (x-axis, log-scale) and excess mortality per million residents by 5 May 2020 (y-axis). Each point is a country (ISO3 code). A moderate positive correlation is observed (Spearman ρ = 0.53, p ≈ 0.007), indicating higher early air connectivity was associated with greater first-wave excess mortality."}
p20 <- corr_df |> 
  filter(target_date == as.Date("2020-05-05")) |> 
  ggplot(aes(
    total_inbound_flights_combined,
    excess_mortality_cumulative_per_million
  )) +
  geom_point(size = 3, alpha = .8, colour = "#009E73") +
  geom_text_repel(aes(label = iso3), max.overlaps = 12, size = 3) +
  scale_x_log10(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Direct scheduled passenger flights (log-scale)",
    y = "Excess deaths / million",
  )

p20
ggsave(here(fig_dir, "scatter_2020.png"),
  p20,
  width = 5.6, height = 4, dpi = 300
)
```

**Interpretation:**

Countries with the highest direct air connectivity to China and Hong Kong (such as Germany, the UK, France, and the Netherlands) experienced some of the highest excess mortality rates during the first wave of COVID-19. This positive rank correlation (ρ = 0.53) supports the hypothesis that early exposure via direct flights contributed significantly to cross-country differences in first-wave mortality. Outliers (e.g., Sweden, Ireland, Slovakia) may reflect unique domestic factors.

## pp scatter (Inb flights, dec 2019 + mar 2020)

```{r scatter_dec_mar, fig.cap = "Relationship between direct scheduled passenger flights from \ China and Hong Kong (log-scale, x-axis) and cumulative excess mortality per \ million residents measured on 5 May 2020 (y-axis). Panels separate the \ exposure metric for **December 2019** (left) and **March 2020** (right). A \ moderate positive association is visible in both months (Spearman ρ ≈ 0.50 \ and ρ ≈ 0.57). Country codes label (i) the three largest early-exposure hubs \ by flight count and (ii) countries in the top quintile of first-wave excess \ mortality, highlighting the states that drive the correlation." }

snapshots <- corr_df |>
  filter(target_date == as.Date("2020-05-05")) |>
  select(
    iso3, excess_mortality_cumulative_per_million,
    flights_dec19 = total_inbound_flights_dec19,
    flights_mar20 = total_inbound_flights_mar20
  ) |>
  pivot_longer(
    starts_with("flights_"),
    names_to  = "month",
    values_to = "inbound_flights"
  ) |>
  mutate(
    month = factor(
      recode(month,
             flights_dec19 = "Dec 2019",
             flights_mar20 = "Mar 2020"),
      levels = c("Dec 2019", "Mar 2020"))
  ) |>
  filter(inbound_flights > 0) # drop zero-flight countries

stats_lbl <- snapshots |>
  group_by(month) |>
  summarise(
    rho = cor(inbound_flights,
              excess_mortality_cumulative_per_million,
              method = "spearman")
  ) |>
  mutate(label = sprintf("ρ ≈ %.2f", rho),
         x = max(snapshots$inbound_flights)*0.9,
         y = min(snapshots$excess_mortality_cumulative_per_million)*0.9)

gg_pp <- ggplot(
  snapshots,
  aes(inbound_flights, excess_mortality_cumulative_per_million)
) +
  geom_point(size = 3, alpha = 0.8, colour = "#009E73") +
  geom_text_repel(
    data  = \(d) d |> filter(iso3 %in% c("ESP","ITA","GBR","DEU","BEL","FRA", "NLD")),
    aes(label = iso3),
    size  = 3
  ) +
  geom_text(
    data = stats_lbl,
    aes(x = x, y = y, label = label),
    hjust = 1, vjust = 0, size = 3, fontface = "bold",
    colour = "grey30"
  ) +
  scale_x_log10(
    breaks = c(1,3,10,30,100,300,1000),
    labels = scales::comma,
    expand = expansion(mult = c(.05, .02))
  ) +
  scale_y_continuous(
    labels = scales::comma,
    expand = expansion(mult = .03)
  ) +
  facet_wrap(~month, nrow = 1) +
  labs(
    x = "Direct scheduled passenger flights (log-scale)",
    y = "Excess deaths / million (to 5 May 2020)"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    strip.text    = element_text(face = "bold"),
    panel.spacing = grid::unit(1, "cm")
  )

gg_pp

ggsave(
  here(fig_dir, "scatter_dec_mar.png"),
  gg_pp, width = 7.3, height = 3.8, dpi = 300, bg = "transparent"
)
```

**Interpretation:**

* **Consistent moderate association:** In both December 2019 and March 2020, countries with more direct scheduled passenger flights from China and Hong Kong tended to have higher excess mortality by early May 2020. This relationship is reflected in moderate Spearman correlations (ρ ≈ 0.50–0.57).

* **Pattern driven by hubs and hardest-hit countries:** The association is strongest for major Western European air hubs—such as Spain, Italy, the UK, Belgium, France, and the Netherlands—which were among the first and worst affected in the pandemic’s initial wave.

* **Interpretation:** These results support the hypothesis that early international connectivity played a significant role in seeding the first wave of SARS-CoV-2 across Europe. However, not all highly connected countries suffered high mortality, and not all countries with high mortality were major hubs—indicating that factors beyond air traffic (e.g., timing of interventions, population age, health system readiness) also shaped outcomes.

* **Caveat:** The observed association diminishes in later periods as local transmission and domestic factors become the dominant determinants of excess mortality, which aligns with global findings that border controls have the most impact only before widespread community spread is established.

## Caterpillar plot 

```{r caterpillar, fig.cap="Spearman ρ (±95% bootstrap CI) between early flight exposure and excess mortality, by reference year. The association is strongly positive in 2020, fades in 2021, and turns negative from 2022 onward."}

pal <- c(
  "Dec 2019" = "#E69F00",
  "Mar 2020" = "#56B4E9",
  "Combined" = "#009E73"
)

gg_cater <- spearman_res |>
  filter(variable %in% c("Dec 2019", "Mar 2020", "Combined")) |>
  mutate(variable = factor(variable,
                           levels = c("Combined", "Dec 2019", "Mar 2020"))) |>
  ggplot(aes(year, rho, colour = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey30") +
  geom_errorbar(
    aes(ymin = ci_lo, ymax = ci_hi),
    width = .15, linewidth = .9,
    position = position_dodge(width = .4)
  ) +
  geom_point(size = 3, position = position_dodge(width = .4)) +
  scale_colour_manual(values = pal, name = NULL) +
  labs(x = NULL, y = "Spearman ρ (± 95 % CI)") +
  theme_minimal(base_size = 11) +
  theme(legend.position = "top")

gg_cater

ggsave(here(fig_dir, "rho_caterpillar.png"),
       gg_cater, width = 6, height = 4, dpi = 300, bg = "transparent")

```

**Interpretation:**
* All three exposure metrics are clearly positive in 2020; in 2021 their CIs straddle zero, and from 2022 the combined metric is significantly negative, confirming a genuine sign-flip rather than sampling noise.

# Limitations {#limitations}

Can be used for Thesis.qmd

## Data limitations

**Flight-exposure proxy (EUROCONTROL, IFR plans).**
  Our exposure estimates count ICAO flight types S (scheduled) and N (non-scheduled commercial) as reported in EUROCONTROL's IFR data.
  -  Actual passenger numbers per flight are unknown; all filed flights—including "ghost" (very low-occupancy) and cargo-only flights—are counted equally.
  - Itineraries with connecting segments via third-country hubs (e.g., DXB, DOH) are not fully captured, so exposure is under-estimated for transfer states and may be over-estimated for major cargo airports such as Liège.
  - In 2020, Liège Airport handled over 1.1 million metric tons of airfreight (ranking 6th in Europe), with cargo volumes rising 23.5% year-on-year despite the pandemic—contrasting with heavy declines in passenger traffic at most airports [@fraport2021]. This highlights the distinct behavior of cargo airports, where flight counts and exposure indices remained elevated due to surging demand for freight and widespread use of "preighter" operations (passenger planes repurposed for cargo).
  - Only four "representative" months (Mar, Jun, Sep, Dec) are available per year from EUROCONTROL's data releases [@eurocontrolData2025], potentially missing key seeding windows (February 2020).

This limitation is directly reflected in our results: for example, Belgium’s exposure index does not drop in line with other countries during the pandemic period (**see Figure @pct_change_filtered**), consistent with Liège’s unique role as a freight hub.


**Ghost/Abnormal flights (load factor bias).**
  The phenomenon of "ghost flights"-nearly empty planes operated during the pandemic, often for slot-retention reasons-is well documented in Europe [@sun2022_b]. @sun2022_b show that such flights peaked in March-April 2020, especially among low-cost carriers and on frequently served intra-European routes.
  - Our exposure metric does not capture actual passenger loads or distinguish between ghost, cargo, or regularly filled flights, so "exposure" may be overstated for affected periods/routes.
  - @sun2022_b  focus on intra-European markets; the extent of "ghost flights" on China–Europe routes remains unclear, but similar slot-related pressures likely played a role early in the pandemic.

[!!!!! Research more about Chinese airlines and ghost flights, especially in the first months of 2020.]

[TODO: Read Warnock-Smith et al 2021 https://www.sciencedirect.com/science/article/pii/S0969699721000685]

* **Passenger vs. Cargo Dynamics: Exposure Index Bias at Cargo Hubs.**
  A core limitation of our flight-exposure proxy is that it cannot distinguish between passenger, cargo, and “ghost” flights (near-empty for slot retention), especially at major hubs. While most European airports saw catastrophic declines in passenger traffic during 2020 (e.g., Frankfurt -74%, [@fraport2021]), cargo hubs like Liège (+23.5% cargo volume year-over-year (YoY)) or Frankfurt (-8.3% cargo) showed much greater resilience—partly due to a surge in dedicated freighters and “preighter” (cargo-only) flights. At Frankfurt, over 8,600 preighter flights accounted for 8% of annual cargo, and freighters made up 80% of cargo movements.
  Consequently, flight counts and exposure indices may significantly overstate real human exposure at major cargo airports. This explains why indices for Belgium and Germany remained high despite catastrophic drops in passenger travel (see Figure @pct_change_filtered)—a pattern also seen at other major cargo hubs. Such discrepancies highlight the importance of careful interpretation when relying on flight-based proxies for pandemic exposure.

[HIGHLY IMPORTANT HERE: DESCRIPTIVE PLTOS THAT SHOWCASE DECLINE! BIG ONE! NOW I CAN EXPLAIN WHY GERMANY AND BELGIUM KEPT CONSISTENT!]
[See fraport and delcine of descirptive plots!]


* **Two-month window (Dec 2019 & Mar 2020).**  
  EUROCONTROL’s public archive releases only four sample months per year; February—a critical seeding month—is missing [@eurocontrolData2025].

* **Excess-mortality uncertainty.**  
  Outcome data merge the World Mortality Dataset with HMD-STMF. National registration lags, baseline-fit choices, and wartime disruption (Ukraine ≥ 2022) widen credible intervals [@karlinsky2021; @msemburi2023]. Notably, @msemburi2023. caution that "basing rankings on point estimates will often be misleading" and discuss the "hazards of ranking countries' epidemic responses" given large data and model uncertainties.
  – A ± 7-day tolerance around 5 May grabs the nearest non-NA value (day_diff ≤ 7); this reduces missingness but adds timing noise.
  – Country ranks are more stable than absolute levels, yet still volatile for very small populations.
  – As emphasized by @msemburi2023, "hazards of ranking countries’ epidemic responses based solely on excess-mortality estimates should be acknowledged."

* **Population denominator.**  
  OWID’s mid-2020 snapshot (UN WPP 2024–derived) differs from raw WPP by < 5 % in 38 / 41 countries; the largest gaps (Cyprus –31 %, Ukraine –11 %, North Macedonia +11 %) stem from boundary or census updates. Re-running all correlations with WPP figures shifts Spearman ρ by **< 0.01**, so OWID values were retained for consistency.

### Methodological  

* **Ecological, country-level design.**  
  Results are based on national aggregates, which mask substantial sub-national variation in both air-traffic exposure and health outcomes (e.g. Lombardy vs. Sicily in Italy).
  – This approach risks the ecological fallacy: relationships observed at the country level may not hold at the city, regional, or individual level.
  – Therefore, findings should not be interpreted as causal or representative for specific regions or population subgroups.


* **Small-N, rank-based correlation.**  
  With ≈ 25 observations, Spearman ρ is sensitive to ties and outliers; one hub country can swing the estimate. We report 5 000-replicate bootstrap CIs, but sampling error remains large [@diciccio1996].


* **Residual confounding.**  
  Excess-mortality differences across countries are strongly shaped by vulnerability factors—GDP, poverty, and income inequality. We do **not** adjust for these, so findings may reflect socioeconomic risk more than direct effects of air connectivity [@ioannidis2023]. - Ward et al 2024 - msemburi et al 2023 ..
  


### Causal interpretation  

* **No causal identification.**  
  December exposure precedes the European outbreak (minimising reverse causation), but March exposure is already influenced by border closures, so causality could run either way.

* **External validity.**  
  Findings apply to continental EUROCONTROL members during the Wuhan/Alpha period. Extrapolation to later variants, island nations, or other regions should be cautious.

> **Bottom line:** The study is *hypothesis-generating*. Direct air connectivity plausibly seeded Europe’s first wave, but its statistical signal disappears once community transmission dominates. Data gaps, ecological design, and unmeasured confounders limit strong policy conclusions about long-run border-control effectiveness.

# Robustness check

```{r robustness_table}
boot_rho <- function(data, idx, xvar) {
  with(
    data[idx, ],
    cor(get(xvar),
        excess_mortality_cumulative_per_million,
        method = "spearman",
        use   = "complete.obs")
  )
}

# NEXT ! 

```

## Reverse causation

Early flight exposure is measured **before** first-wave mortality peaks; therefore, high deaths could not have caused higher December exposure. Correlation using **Dec-only** flights (ρ ≈ 0.50) shows the pattern predates policy cuts.

## Take-away  

> **Early seeding signal, rapidly eclipsed.**  
> Direct flights from China / Hong Kong explain roughly one-quarter of the *cross-country* spread in first-wave excess mortality (May 2020). That signal fades to zero in 2021 and reverses thereafter, once community transmission and domestic counter-measures dominate outcomes.


