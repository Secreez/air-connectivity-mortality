---
title:  "Inbound flights × excess mortality — correlation results"
author: "M. Elixhauser"
format:
  html:
    toc: true
    toc-depth: 2
    code-fold: true
freeze: auto
execute:
  echo: false 
---

```{r setup, include = FALSE}
source(here::here("R", "00_load_libs.R"))

fig_dir <- here("data/figures")
dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)

analysis_df <- read_rds(here("data/processed/analysis_df.rds"))

pop_df <- read_csv(
  here("data/raw/owid/owid-covid-data.csv"),
  show_col_types = FALSE,
  col_select     = c(iso_code, date, population)
) |>
  filter(lubridate::year(date) == 2020) |>
  group_by(iso_code) |>
  slice_max(date, with_ties = FALSE) |>
  ungroup() |>
  transmute(iso3 = iso_code, population)
```

## Analysis data set

```{r}
corr_df <- analysis_df |>
  semi_join(analysis_df |> count(iso3) |> filter(n == 4), by = "iso3") |>
  left_join(pop_df, by = "iso3") |>
  mutate(flights_pm = total_inbound_flights_combined / (population / 1e6))
stopifnot(!anyNA(corr_df$flights_pm))
```

## Spearman's rank correlation (baseline)

```{r}
boot_rho <- function(data, idx, xvar) {
  with(
    data[idx, ],
    cor(get(xvar),
      excess_mortality_cumulative_per_million,
      method = "spearman",
      use = "complete.obs"
    )
  )
}

spearman_by_year <- function(xvar, B = 5000) {
  corr_df |> 
    group_by(target_date) |> 
    group_modify(\(d, key) {
      ok <- complete.cases(
        d[[xvar]],
        d$excess_mortality_cumulative_per_million
      )
      dd <- d[ok, ]
      n <- nrow(dd)

      if (n < 3 ||
        sd(dd[[xvar]]) == 0 ||
        sd(dd$excess_mortality_cumulative_per_million) == 0) {
        return(tibble(
          rho = NA, ci_lo = NA, ci_hi = NA,
          p = NA, n = n
        ))
      }

      rho <- cor(dd[[xvar]], dd$excess_mortality_cumulative_per_million,
        method = "spearman"
      )
      pval <- cor.test(dd[[xvar]], dd$excess_mortality_cumulative_per_million,
        method = "spearman", exact = FALSE
      )$p.value

      set.seed(42)
      ci <- if (n >= 4) {
        boot(dd, boot_rho, R = B, xvar = xvar) |>
          (\(b) quantile(b$t, c(.025, .975), na.rm = TRUE))() # .025, .975 CI (why used!)
      } else {
        c(NA, NA)
      }

      tibble(
        rho = rho,
        ci_lo = ci[1],
        ci_hi = ci[2],
        p = pval,
        n = n
      )
    }) |> 
    ungroup() |> 
    mutate(
      variable = xvar,
      year = lubridate::year(target_date)
    )
}

spearman_res <- purrr::map_dfr(
  c(
    "total_inbound_flights_dec19",
    "total_inbound_flights_mar20",
    "total_inbound_flights_combined",
    "flights_pm"
  ),
  spearman_by_year
) %>%
  mutate(variable = dplyr::recode(variable,
    total_inbound_flights_dec19    = "Dec 2019",
    total_inbound_flights_mar20    = "Mar 2020",
    total_inbound_flights_combined = "Combined",
    flights_pm                     = "Flights / M pop"
  ))
```


```{r}
knitr::kable(
  spearman_res |>
    select(year, variable, rho, ci_lo, ci_hi, p, n) |>
    mutate(across(where(is.numeric), \(x) round(x, 3))),
  caption = "Table 4-1 Spearman ρ between early flight exposure and cumulative excess mortality."
)
```

**Key patterns:**
- Early air conenctivity explains a sizeable share of the cross-country variation in first-wave excess mortality. (ρ ≈ -0.45, 95 % CI 0.18-0.80; ρ < 0.01).
- From 2021 onwards the simple rank correlation vanishes; by 2022-23 it turns modestly negative (ρ ≈ -0.45, 95 % CI -0.79-0.00).
- The sign change is larger than the bootstrap confidence intervals, indicating that it is unlikely to be due to sampling noise in a 25-country sample.

**Interpretation:**
International flights mattered only during the narrow "pre-transmission window" (need better term). Once SARS-CoV-2 was seeded "everywhere", subsequent excess mrotality was driven by domestic factors (age structure, public-health response, vaccination, health-system strain) rather than by additional import pressure. This finding is ... (search for SOURCE in: diminishing return or not of border closures after local circulation is established.. could be interesting)

**Why bootstrap CIs?**

We drew 5 000 bootstrap resamples, following the ≥ 2 000‑replicates guidance for small‑$n$ studies (DiCiccio & Efron 1996). Empirical work shows that coverage error for correlation CIs stabilises by ≈ 4 000 resamples (Tong et al. 2016; Mokhtar 2023). Five thousand therefore offers stable tails at negligible computational cost. A fixed random seed (`set.seed(42)`) makes the intervals exactly reproducible.

# Visualizing the trend

## p over time
```{r}
p_rho <- ggplot(
  spearman_res,
  aes(target_date, rho, colour = variable, group = variable)
) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2.4) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey60") +
  scale_x_date(date_labels = "%Y") +
  labs(x = NULL, y = "Spearman ρ", colour = NULL) +
  theme_minimal(base_size = 11) +
  theme(legend.position = "top")

p_rho |> (\(p) {
  ggsave(
    filename = here(fig_dir, "rho_timeseries.png"),
    plot = p,
    width = 6, height = 4, dpi = 300, bg = "transparent"
  )
  p
})()
```

**Take-away:**

- Import effect is early and short-lived. Direct flights explain ≈ 3 % of the rank variance in May 2020, but < 10 %  from 2021 onwards. …
- Once the virus is seeded, domestic factors dominate. The mere fact of being well-connected n longer increases cumulative mrotality and may evne correlate with lower late-period deaths (?)
- Policy implciation (exploratory) Border controls can delay the first wave but have little leverage on the long-run toll unelss coupled with sustained internal measures.

## Snapshot scatter (05 May 2020)
```{r}
p20 <- corr_df |> 
  filter(target_date == as.Date("2020-05-05")) |> 
  ggplot(aes(
    total_inbound_flights_combined,
    excess_mortality_cumulative_per_million
  )) +
  geom_point(size = 3, alpha = .8, colour = "#2b8cbe") +
  geom_text_repel(aes(label = iso3), max.overlaps = 12, size = 3) +
  scale_x_log10(labels = scales::comma) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "Inbound flights (log-scale)",
    y = "Excess deaths / million",
    caption = "ρ = 0.53 (p ≈ 0.007)"
  )

p20
ggsave(here(fig_dir, "scatter_2020.png"),
  p20,
  width = 5.6, height = 4, dpi = 300
)
```

## pp scatter (Inb flights, dec 2019 + mar 2020)

```{r}
snapshots <- corr_df |>
  filter(target_date == as.Date("2020-05-05")) |>
  select(
    iso3, excess_mortality_cumulative_per_million,
    flights_dec19 = total_inbound_flights_dec19,
    flights_mar20 = total_inbound_flights_mar20
  ) |>
  pivot_longer(
    starts_with("flights_"),
    names_to = "month", values_to = "inbound_flights"
  ) |>
  mutate(
    month = factor(
      recode(month,
        flights_dec19 = "Dec 2019",
        flights_mar20 = "Mar 2020"
      ),
      levels = c("Dec 2019", "Mar 2020")
    )
  ) |>
  filter(inbound_flights > 0) # drop zero‑flight countries

gg_pp <- ggplot(
  snapshots,
  aes(inbound_flights, excess_mortality_cumulative_per_million)
) +
  geom_point(size = 3, alpha = .75, colour = "#2b8cbe") +
  geom_text_repel(
    data = \(d) d |> filter(iso3 %in% c("ESP", "ITA", "GBR", "DEU", "BEL", "FRA")),
    aes(label = iso3), family = "sans", size = 3
  ) +
  scale_x_log10(
    breaks  = c(1, 3, 10, 30, 100, 300, 1000),
    labels  = scales::comma,
    expand  = expansion(mult = c(.05, .02)) # added bit of breathing room (because of log on x axis)
  ) +
  scale_y_continuous(
    labels  = scales::comma,
    expand  = expansion(mult = .03)
  ) +
  facet_wrap(~month, nrow = 1) +
  labs(
    x = "Inbound flights (log-scale)",
    y = "Excess deaths / million (to 5 May 2020)",
    caption = "Spearman ρ: Dec 2019 ≈ 0.50  Mar 2020 ≈ 0.57"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    strip.text = element_text(face = "bold"),
    panel.spacing = unit(1, "cm")
  )

gg_pp

ggsave(here(fig_dir, "scatter_dec-mar.png"),
  gg_pp,
  width = 7.3, height = 3.8, dpi = 300, bg = "transparent"
)
```


## Caterpillar plot 

```{r}
gg_cater <- spearman_res |>
  filter(variable %in% c("Dec 2019", "Mar 2020", "Combined")) |>
  mutate(variable = factor(variable, c("Combined", "Dec 2019", "Mar 2020"))) |>
  ggplot(aes(year, rho, colour = variable)) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey60") +
  geom_errorbar(aes(ymin = ci_lo, ymax = ci_hi),
    width = .15, linewidth = .9, position = position_dodge(width = .4)
  ) +
  geom_point(size = 3, position = position_dodge(width = .4)) +
  scale_colour_manual(values = c(
    "Combined" = "#e76f51",
    "Dec 2019" = "#2a9d8f",
    "Mar 2020" = "#457b9d"
  )) +
  labs(x = NULL, y = "Spearman ρ (± 95 % CI)", colour = NULL) +
  theme_minimal(base_size = 11) +
  theme(legend.position = "top")

gg_cater

ggsave(here(fig_dir, "rho_caterpillar.png"),
  gg_cater,
  width = 6, height = 4, dpi = 300, bg = "transparent"
)
```
All three exposure metrics are clearly positive in 2020.
In 2021 their confidence intervals straddle zero, indicating the association has essentially disappeared. From 2022 onward the Combined and Flights‑per‑million measures become significantly negative (95 % CI entirely < 0), while the single‑month metrics hover just either side of zero. This confirms a genuine sign‑flip rather than sampling noise.

# Robustness check

# Takeaway
