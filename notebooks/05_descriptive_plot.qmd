---
title: "Descriptive patterns early CN/HK → EUROCONTROL flights"
author: "Maximilian Elixhauser"
format:
  html:
    toc: true
    toc-depth: 2
    code-fold: true
freeze: auto
execute:
  echo: false 
---

```{r setup, include=FALSE}
source(here::here("R", "00_load_libs.R"))
fig_dir <- here::here("data", "figures")
dir.create(fig_dir, showWarnings = FALSE, recursive = TRUE)

flights_country <- read_rds(here("data", "processed", "flights_country.rds"))
flight_exposure <- read_rds(here("data", "processed", "flight_exposure_mapped.rds"))
flows_pairwise <- read_rds(here("data", "processed", "flows_pairwise.rds"))
airports <- read_rds(here("data", "processed", "airports.rds"))
flights_filtered <- read_rds(here("data", "processed", "flights_filtered.rds"))
```

> Among continental EUROCONTROL member states, is a higher volume of direct inbound flights from China / Hong Kong / Macao (Dec 2019 & Mar 2020) associated with higher cumulative excess mortality on 5 May 2020?

Snapshots for 2021-2023 are analysed as robustness checks.

### Objectives

**1. Measure exposure:** Create a country-level index of inbound IFR flights (Dec 2019, Mar 2020, sum) from EUROCONTROL data.

**2. Rank & correlate:** Compute Spearman ρ between exposure ranks and excess-mortality ranks on 5 May 2020; repeat for 2021-2023.

**3. Appraise validity:** Discuss strengths and limits of flight counts as a proxy for epidemic seeding


# Results: Flight Exposure Patterns

## Top 10 Destination Bar
```{r bar_top10, fig.cap="Top 10 European destinations for direct scheduled passenger flights from China and Hong Kong in December 2019 and March 2020. Bars show the number of direct scheduled IFR passenger flights by month and in total (combined). Germany, the UK, and the Netherlands dominated the network, handling the majority of arrivals. Note: No Macao–Europe flights were recorded in the EUROCONTROL dataset.", fig.height=6}
top10 <- flights_country |>
  slice_max(total_inbound_flights_combined, n = 10) |>
  pivot_longer(
    starts_with("total_"),
    names_to  = "window",
    values_to = "flights"
  ) |>
  mutate(
    window = recode(window,
      total_inbound_flights_dec19    = "Dec 2019",
      total_inbound_flights_mar20    = "Mar 2020",
      total_inbound_flights_combined = "Combined"
    ),
    iso_country = fct_reorder(iso_country, flights, .fun = max)
  )

pal <- c(
  "Dec 2019" = "#E69F00",
  "Mar 2020" = "#56B4E9",
  "Combined" = "#009E73"
)

p_top10 <- ggplot(
  top10,
  aes(iso_country, flights, fill = window)
) +
  geom_col(position = position_dodge(width = .75), width = .65) +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = pal, name = NULL) +
  labs(
    title = "Top-10 EUROCONTROL destinations",
    subtitle = "Direct passenger flights from China & Hong Kong*  (Dec 2019 and Mar 2020)",
    x = NULL, y = "Number of flights",
  ) +
  theme_minimal(base_size = 10) +
  theme(
    legend.position = "top",
    legend.justification = "left",
    plot.title.position = "plot",
    axis.text.y = element_text(size = 9)
  )

p_top10

ggsave(here(fig_dir, "bar_top10_destinations.png"),
  plot = p_top10,
  width = 5.8, height = 4.4, dpi = 300,
  bg = "transparent"
)
```

* The acronym CN/HK is used for completeness, although the EUROCONTROL records contain zero Macao–Europe flights in the study windows; analyses therefore reflect traffic from mainland China and Hong Kong only.

In December 2019 the direct CN/HK traffic into Europe was highly concentrated: Germany (DE), the United Kingdom (GB) and the Netherlands (NL) alone handled > 60 % of all arrivals, followed by France and Belgium as secondary hubs. Every other EUROCONTROL state received fewer than 300 flights that month. By March 2020 volumes collapsed everywhere (blue bars) yet the ranking hardly changed: the same three hubs still dominated, each retaining 30-50 % of their December traffic, while Italy, Turkey and Finland - already mid-tier in December - fell below 250 flights. Combining both months (green bars) therefore produces an extremely right-skewed distribution: the top two countries (DE, GB) each saw > 900 direct flights, four times as many as rank #4. Interpretation: epidemic "import pressure" from direct flights was not evenly spread across Europe; instead, a small group of Western European gateways bore the brunt of exposure in both the initial seeding phase (December 2019) and the onset of pandemic restrictions (March 2020), when coordinated lockdowns and border closures rapidly reduced international flight volumes.


## Route diversity

### Panel Plot: Distinct origins per destination (combined & monthly)

```{r top_15_origins, fig.cap = "Distinct CN/HK origin airports per EUROCONTROL destination: The left panel (‘Combined’) shows the total number of different Chinese and Hong Kong airports directly connected by direct scheduled passenger flights to each of the top 15 European destinations across both study months; the right panel breaks this down by December 2019 and March 2020. Major Western European hubs (London-Heathrow, Paris-CDG, Frankfurt) received flights from the widest range of origins, while most other destinations were linked to only a few. This highlights that early seeding risk was concentrated not just in flight volume but in route diversity."}
top15 <- flows_pairwise |>
  distinct(ADEP, ADES) |>
  count(ADES, name = "n_origins") |>
  slice_max(n_origins, n = 15) |>
  pull(ADES)

combined_df <- flows_pairwise |>
  filter(ADES %in% top15) |>
  distinct(ADEP, ADES) |>
  count(ADES, name = "n_origins") |>
  left_join(airports, by = c(ADES = "icao_code")) |>
  mutate(
    panel = "Combined",
    month = "Combined"
  )

monthly_df <- flights_filtered |>
  filter(ADES %in% top15) |>
  distinct(month, ADEP, ADES) |>
  count(month, ADES, name = "n_origins") |>
  left_join(airports, by = c(ADES = "icao_code")) |>
  mutate(
    month = recode(month, dec19 = "Dec 2019", mar20 = "Mar 2020"),
    panel = "Monthly"
  )

plot_df <- bind_rows(combined_df, monthly_df) |>
  mutate(
    name  = fct_reorder(name, n_origins),
    month = factor(month, levels = c("Combined", "Dec 2019", "Mar 2020")),
    panel = factor(panel, levels = c("Combined", "Monthly"))
  )

pal_fill <- c(
  "Combined" = "#009E73",
  "Dec 2019" = "#E69F00",
  "Mar 2020" = "#56B4E9"
)

panel_plot <- ggplot(plot_df, aes(n_origins, name, fill = month)) +
  geom_col(width = .6, position = position_dodge(width = .6)) +
  facet_grid(. ~ panel,
    scales = "fixed",
    space  = "free_x"
  ) +
  scale_fill_manual(values = pal_fill, name = NULL) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(
    title = "How many different CN/HK airports feed each EUROCONTROL destination?",
    x = "Unique origin airports",
    y = NULL
  ) +
  theme_minimal(base_size = 9) +
  theme(
    strip.text      = element_text(face = "bold"),
    axis.text.y     = element_text(size = 7),
    legend.position = "top",
    panel.spacing.x = unit(1.1, "cm")
  )

panel_plot

ggsave(here(fig_dir, "bar_origins_per_destination.png"),
  panel_plot,
  width = 6.3, height = 4.5, dpi = 300, bg = "transparent"
)
```

Direct links were not only concentrated by volume (see @bar_top10), but also by route diversity. In total, 15 CN/HK airports fed London-Heathrow, 13 fed Paris-CDG and 12 fed Frankfurt between December 2019 and March 2020 (left panel, green bars). Every other EUROCONTROL destination received routes from ≤ 10 origins, and most from fewer than 6. The month-specific panel (right) reveals that this breadth of origins existed already in December (orange) and, despite the March collapse (blue), the major hubs still drew from 4-6 different airports while almost all secondary gateways fell to one or two. **Implication:** the first-wave seeding risk was amplified not just by sheer flight counts but by the variety of source cities funnelling into the same Western European hubs, increasing the chance of multiple independent introductions.

([Could be a good sentence for correlation after:] Because both exposure volume and diversity are right-skewed toward a handful of destinations, correlations with excess mortality might be driven by these outliers as much as by a monotone trend across all countries—an issue the next section explores with rank-based statistics and robustness checks.)

### Scatterplot: log volume vs. route diversity (airport level)

```{r scatter_volume_vs_diversity, fig.height=5, fig.cap="Relationship between total direct scheduled passenger flight volume (log-scale) and route diversity for EUROCONTROL airports. Major Western European hubs combined high volume and high diversity, driving the positive association (Spearman ρ ≈ 0.86) seen here."}

dest_stats <- flows_pairwise |>
  group_by(ADES) |>
  summarise(
    total_flights = sum(n_flights),
    n_origins = n_distinct(ADEP),
    .groups = "drop"
  ) |>
  filter(total_flights > 0) |>
  left_join(airports, by = c("ADES" = "icao_code")) |>
  mutate(short_name = str_remove(name, " (International )?Airport$"))

# one-liner Spearman calculation
air_cor <- cor.test(dest_stats$total_flights,
  dest_stats$n_origins,
  method = "spearman", exact = FALSE
)

# round for reporting
rho_air <- round(unname(air_cor$estimate), 2) # 0.86
p_air <- format.pval(air_cor$p.value, digits = 2) # < 0.001


p_scatter <- ggplot(
  dest_stats,
  aes(x = total_flights, y = n_origins)
) +
  geom_point(size = 3, alpha = .75, colour = "#56B4E9") +
  geom_text_repel(
    data = dest_stats |> filter(total_flights > 200 | n_origins > 8),
    aes(label = short_name), size = 3, max.overlaps = 10
  ) +
  scale_x_log10(labels = comma, expand = c(0.02, 0)) +
  labs(
    title = "Volume vs Route Diversity",
    subtitle = "Each dot = one EUROCONTROL destination airport",
    x = "Total direct flights (Dec 2019 + Mar 2020, log-scale)",
    y = "Distinct CN/HK origin airports",
    caption = glue::glue("Spearman ρ = {rho_air} (p {p_air}); n = {nrow(dest_stats)} airports")
  ) +
  theme_minimal(base_size = 11)

p_scatter

ggsave(here(fig_dir, "scatter_volume_vs_origins.png"),
  p_scatter,
  width = 6, height = 4.5, dpi = 300, bg = "transparent"
)
```
* **Clear positive association.** Among the 38 EUROCONTROL airports that handled at least one direct flight from CN/HK in Dec 2019 + Mar 2020, flight volume and route diversity rise together (Spearman ρ ≈ 0.86, p < 0.001). *Rule of thumb:* every additional ~100 flights is accompanied by **≈ 1–2 extra origin airports**.
* **Strong right-skew.** Four hubs dominate the distribution: **Heathrow** (748 flights / 15 origins), **Frankfurt** (638 / 12), **Amsterdam** (577 / 9) and **Paris-CDG** (469 / 13). All other airports sit below  ~200 flights and ≤ 5 origins. *Implication:* the first-wave "import pressure" was concentrated in a handful of Western-European gateways.
* **Cargo outlier – Liège (LGG).** Liège appears unusually diverse for its mid-range volume (205 / 7). This reflects its role as a **dedicated cargo hub** (UPS, DHL, ...). ADRR treats cargo and passenger flights alike, so LGG’s position may **over-state passenger-borne seeding risk** [Need to research more about cargo overall.]
* **Limitation.** The scatter uses **filed IFR flight plans [see Metadata]**, not passenger counts, and weights each origin airport equally. Route diversity therefore proxies the *opportunity* for multiple introductions, not the number of infected travellers.
* **Link to country-level results.** The same right-skew underlies the country-level correlation (ρ ≈ 0.53 for "combined" exposure): national rankings are driven largely by how heavily these few hubs connect to CN/HK.

> **Take-away:** Volume and variety grow in lock-step only at the very top of the airport hierarchy. Most European destinations remained both low-volume **and** low-diversity, limiting their early-2020 exposure, whereas the big four hubs acted as the main "funnels" for potential seeding events.

## Collapse Bar: Percentage change (countries with ≥ 5 Dec flights)

```{r pct_change_filtered, fig.cap="Percentage change in direct scheduled passenger flights from China and Hong Kong to EUROCONTROL member states, comparing March 2020 to December 2019. Countries shown handled at least five inbound flights in December; most saw reductions exceeding 90% by March 2020 as international travel collapsed during the initial pandemic response", fig.height=6}
pct_df <- flight_exposure |>
  transmute(
    country = country_name,
    dec     = total_inbound_flights_dec19,
    mar     = total_inbound_flights_mar20,
    pct     = 100 * (mar - dec) / dec
  ) |>
  filter(dec >= 5) |>
  arrange(pct) |>
  mutate(country = fct_reorder(country, pct))

p_collapse <- ggplot(
  pct_df,
  aes(x = pct, y = country, fill = pct > 0)
) +
  geom_col(width = .72, show.legend = FALSE) +
  scale_fill_manual(values = c(`TRUE` = "#56B4E9", `FALSE` = "#E69F00")) +
  scale_x_continuous(
    limits = c(-105, 5), breaks = seq(-100, 0, 25),
    labels = \(x) paste0(x, "%")
  ) +
  labs(
    title = "March collapse in direct CN/HK → EUROCONTROL flights",
    subtitle = "Countries with ≥ 5 flights in Dec 2019",
    x = "% change  (Mar 2020 vs Dec 2019)", y = NULL
  ) +
  theme_minimal(base_size = 11)

p_collapse
ggsave(here(fig_dir, "pct_change_filtered.png"),
  p_collapse,
  width = 6.3, height = 4.5, dpi = 300, bg = "transparent"
)
```

* **Near-universal contraction.** By late March 2020 every EUROCONTROL member with ≥ 5 December flights had cut at least half of its direct links; **15 of 19 countries slashed > 90 %** (Fig. X).
* **Policy timing.** The cliff-edge coincides with two coordinated border measures: (i) the EU/Schengen external-border stop of **17 March 2020** (@EU2020), and (ii) China’s **"Five-One" rule of 26 March 2020**, which limited each airline to one China-Europe passenger rotation per week (@CAAC2020).
* **Hubs vs. medium markets.** Major transfer states—UK, Germany, Netherlands—still operated hundreds of flights after a 50-70 % cut, whereas medium markets such as Italy, Austria and the Nordics fell to single-digit (or zero) services.
* **Interpretation.** Percentage change reflects the policy response; residual flight counts indicate where absolute seeding risk persisted. Subsequent mortality correlations therefore need to control for this highly concentrated residual volume.

## Full numeric table (all ≥  5-flight countries)

```{r collapse_tbl}
collapse_tbl <- pct_df |>
  mutate(
    `Dec 2019` = scales::comma(dec),
    `Mar 2020` = scales::comma(mar),
    `% change` = sprintf("%+.0f %%", pct),
    `Δ flights` = scales::comma(mar - dec)
  ) |>
  select(Country = country, `Dec 2019`, `Mar 2020`, `% change`, `Δ flights`)

knitr::kable(
  collapse_tbl,
  caption = "Direct scheduled passenger flights from China and Hong Kong to EUROCONTROL countries by destination, Dec 2019 vs. Mar 2020, for states with at least five December flights. Table shows absolute and percentage changes; note that residual flight volumes varied widely despite near-universal contraction.",
  align = c("l", "r", "r", "r", "r")
)
```

* **Every country contracted sharply.** All 19 EUROCONTROL states with ≥ 5 December flights cut inbound CN/HK service by ≥ 50 % by March 2020; 15 of them slashed **> 90 %**.
* **Absolute exposure still diverged.** Germany, the UK and the Netherlands each retained **200 – 350 flights** despite large percentage drops, whereas Italy, Austria and the Nordics fell to **single-digit counts** (see "Δ flights" column).  Epidemiologically, residual *volume* matters more than the percentage.
* **Read % with caution.** Extreme figures at tiny bases—e.g. Luxembourg –100 % (8→0), Georgia –100 % (14→0)—signal "service discontinued", not a large change in risk.

## Top-10 drops and increases table

```{r top_tbl}
top_tbl <- pct_df |>
  mutate(
    direction = if_else(pct < 0, "Largest drop", "Largest increase"),
    `Dec 2019` = dec,
    `Mar 2020` = mar,
    `% change` = sprintf("%+.0f %%", pct),
    `Δ flights` = mar - dec
  ) |>
  arrange(direction, pct) |>
  group_by(direction) |>
  slice_head(n = 10) |>
  mutate(Rank = row_number()) |>
  ungroup() |>
  select(direction, Rank,
    Country = country,
    `Dec 2019`, `Mar 2020`, `% change`, `Δ flights`
  )
knitr::kable(
  top_tbl,
  caption = "Largest proportional drops and increases in direct CN/HK → EUROCONTROL flights, Mar 2020 vs. Dec 2019, by country (≥ 5 Dec flights). Note: Some 'increases' are due to low baseline volumes.",
  align = c("l", "r", "l", "r", "r", "r", "r"),
  format.args = list(big.mark = ",")
)
```

* **Largest drops**: Hub–and-spoke carriers in Italy, Türkiye, Finland and Denmark virtually shut direct CN/HK traffic (–86 % to –96 %).
* **Largest "increases"** are statistical artefacts. Latvia (+400 %) and Lithuania (+200 %) rose from *one* charter to 4–5 rotations—epidemiologically negligible.
* **Hubs absorb the floor effect.** The UK, Germany and the Netherlands appear under "increases" because they still ran hundreds of flights; their percentage fall was "only" –50 % to –66 %, but the absolute cut was 180 – 450 flights.

> **Take-away.** Percentage change captures the **policy shock**; the "Δ flights" column captures the **residual seeding potential**.  Subsequent excess-mortality analysis should therefore weight *absolute* exposure, not just percentage cuts.

# Optional / Appendix

## Origin-airport bar (top 25)

```{r origin_stack, fig.cap="Top 25 Chinese and Hong Kong airports ranked by the total number of direct scheduled passenger flights to EUROCONTROL countries. Bars show flights in December 2019 (orange) and March 2020 (blue). Major sources include Beijing, Shanghai, and Hong Kong, but many other cities contributed smaller volumes. The distribution highlights the diversity of origin airports supplying Europe prior to the pandemic collapse."}
origin_df <- flights_filtered |>
  count(month, ADEP, name = "flights") |>
  left_join(airports, by = c("ADEP" = "icao_code")) |>
  group_by(ADEP) |>
  mutate(total = sum(flights)) |>
  ungroup() |>
  arrange(desc(total)) |>
  slice_head(n = 25) |>
  mutate(
    short_name = str_remove(name, " (International )?Airport$"),
    month      = recode(month, dec19 = "Dec 2019", mar20 = "Mar 2020"),
    short_name = fct_reorder(short_name, total)
  )

pal_window <- c(
  "Dec 2019" = "#E69F00",
  "Mar 2020" = "#56B4E9"
)

p_orig <- ggplot(
  origin_df,
  aes(short_name, flights, fill = month)
) +
  geom_col(position = "stack", width = .75) +
  coord_flip() +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = pal_window, name = NULL) +
  labs(
    title = "Inbound flight counts by CN/HK origin airport",
    subtitle = "Top 25 origins  December 2019 (orange) vs March 2020 (blue)",
    x = NULL, y = "Number of direct passenger flights"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    legend.position      = "top",
    legend.justification = "left",
    axis.text.y          = element_text(size = 8)
  )

p_orig

ggsave(here(fig_dir, "bar_origins_top25.png"),
       p_orig,
       width = 6.3, height = 5.2, dpi = 300, bg = "transparent"
       )
```

The next section quantifies how these residual volumes relate to first-wave excess mortality.
