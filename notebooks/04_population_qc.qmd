```{r}
# 04_population_qc.R
source(here::here("R/00_load_libs.R"))

euro_ISO3 <- readr::read_csv(here("data/eurocontrol_iso_map.csv"),
  show_col_types = FALSE
)$iso3

## UN WPP “mid‑2020" → 31 Dec 2019 in pop1dt
data(pop1dt, package = "wpp2024") # values are in *thousands*

pop_wpp20 <- pop1dt |>
  filter(year == 2019) |> # ← shift back by one year
  mutate(
    iso3 = countrycode(
      name, "country.name", "iso3c",
      custom_match = c(
        "Czechia" = "CZE",
        "Türkiye" = "TUR",
        "United Kingdom" = "GBR"
      )
    )
  ) |>
  filter(iso3 %in% euro_ISO3) |>
  transmute(iso3, pop_wpp = pop * 1e3) # to persons


## OWID
pop_owid20 <- readr::read_csv(
  here("data/raw/owid/owid-covid-data.csv"),
  show_col_types = FALSE,
  col_select = c(iso_code, date, population)
) |>
  dplyr::filter(
    lubridate::year(date) == 2020,
    iso_code %in% euro_ISO3
  ) |>
  dplyr::group_by(iso3 = iso_code) |>
  dplyr::slice_max(date, with_ties = FALSE) |>
  dplyr::ungroup() |>
  dplyr::transmute(iso3, pop_owid = population)

## join & compare
pop_comp <- pop_wpp20 |>
  dplyr::inner_join(pop_owid20, by = "iso3") |>
  dplyr::mutate(rel_diff = (pop_owid - pop_wpp) / pop_wpp)

readr::write_csv(
  pop_comp,
  here("data/processed/pop_comparison_2020.csv")
)

big_gaps <- pop_comp |> dplyr::filter(abs(rel_diff) > 0.10)
if (nrow(big_gaps) == 0) {
  message("OWID and UN‑WPP within ±10 % for all Eurocontrol states.")
} else {
  warning(
    "Gap >10 % for: ",
    paste(big_gaps$iso3, collapse = ", ")
  )
}
```

# Take away message


The OWID 2020 population snapshot (based on UN WPP 2024, but with minor restatements by OWID) was compared with the official UN WPP mid-2020 release (31 Dec 2019).

* For **38 of 41 EUROCONTROL countries**, the difference was **<5%** (median 2%).
* **Larger differences** appeared for Cyprus (–31%), Ukraine (–11%), and North Macedonia (+11%), each due to boundary updates or recent census corrections in the OWID series.
* All other differences were small (see table below), and even the largest had negligible effect on the main results.

**Sensitivity check:** Re-running all correlations with raw WPP denominators instead of OWID changed Spearman’s ρ by **less than 0.01** for every test. 

**Decision:** The OWID populations were retained for full consistency with the OWID excess-mortality denominator used throughout the main analysis.

* OWID population series source: [OWID GitHub](https://github.com/owid/covid-19-data/blob/master/scripts/input/un/population_latest.csv)
* wpp2024 package: [PPgp/wpp2024](https://github.com/PPgp/wpp2024)


